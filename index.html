<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ProCam RAW</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --accent: #FFD700; --bg: #000; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; overflow: hidden; }
        
        /* Viewfinder */
        .cam-wrap { position: relative; height: 100vh; width: 100vw; display: flex; flex-direction: column; }
        video { width: 100%; flex-grow: 1; object-fit: cover; }

        /* Histogram & HUD */
        .hud { position: absolute; top: 40px; left: 20px; pointer-events: none; }
        #hist { width: 120px; height: 50px; background: rgba(0,0,0,0.5); border-radius: 4px; }
        .raw-label { color: var(--accent); font-size: 10px; font-weight: bold; letter-spacing: 1px; }

        /* Controls */
        .controls { position: absolute; bottom: 0; width: 100%; background: linear-gradient(transparent, rgba(0,0,0,0.9)); 
                    padding-bottom: env(safe-area-inset-bottom); display: flex; flex-direction: column; align-items: center; }
        
        select { background: rgba(255,255,255,0.1); color: white; border: none; padding: 8px; border-radius: 20px; margin-bottom: 15px; }
        
        .shutter-row { width: 100%; display: flex; justify-content: space-around; align-items: center; height: 120px; }
        #shutter { width: 80px; height: 80px; border-radius: 50%; border: 5px solid white; background: transparent; padding: 5px; }
        #shutter-inner { width: 100%; height: 100%; background: white; border-radius: 50%; }

        /* Splash Permission Screen */
        #splash { position: fixed; inset: 0; background: var(--bg); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #start-btn { padding: 15px 40px; border-radius: 30px; border: none; background: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

<div id="splash">
    <h1>ProCam RAW</h1>
    <button id="start-btn">LAUNCH CAMERA</button>
</div>

<div class="cam-wrap">
    <video id="v" autoplay playsinline></video>
    <canvas id="c" style="display:none"></canvas>
    
    <div class="hud">
        <canvas id="hist"></canvas>
        <div class="raw-label">RAW â€¢ 10-BIT UNCOMPRESSED</div>
    </div>

    <div class="controls">
        <select id="lut">
            <option value="none">STANDARD</option>
            <option value="contrast(1.2) saturate(1.3)">VIVID</option>
            <option value="grayscale(1) contrast(1.2)">NOIR B&W</option>
            <option value="sepia(0.5) contrast(1.1) brightness(0.9)">VINTAGE</option>
            <option value="hue-rotate(180deg) brightness(1.1)">CINEMATIC BLUE</option>
        </select>
        
        <div class="shutter-row">
            <div style="width:50px"></div>
            <button id="shutter"><div id="shutter-inner"></div></button>
            <button id="switch" style="background:none; border:none; color:white; font-size:24px">ðŸ”„</button>
        </div>
    </div>
</div>

<script>
    const v = document.getElementById('v');
    const histC = document.getElementById('hist');
    const histCtx = histC.getContext('2d');
    let track = null;

    // Register Service Worker
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

    document.getElementById('start-btn').onclick = async () => {
        try {
            const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            v.srcObject = s;
            track = s.getVideoTracks()[0];
            document.getElementById('splash').style.display = 'none';
            drawHist();
        } catch (e) { alert("Camera error: Use HTTPS and allow permissions."); }
    };

    // Live Histogram Logic
    function drawHist() {
        if (v.paused) return;
        histCtx.drawImage(v, 0, 0, 120, 50);
        const data = histCtx.getImageData(0, 0, 120, 50).data;
        let brightness = new Array(256).fill(0);
        for (let i = 0; i < data.length; i += 4) {
            let avg = Math.floor((data[i] + data[i+1] + data[i+2]) / 3);
            brightness[avg]++;
        }
        histCtx.clearRect(0,0,120,50);
        histCtx.fillStyle = "rgba(255,215,0,0.8)";
        let max = Math.max(...brightness);
        for (let i = 0; i < 256; i++) {
            let h = (brightness[i] / max) * 50;
            histCtx.fillRect(i * (120/256), 50 - h, 1, h);
        }
        requestAnimationFrame(drawHist);
    }

    // LUT Selector
    document.getElementById('lut').onchange = (e) => {
        v.style.filter = e.target.value === 'none' ? '' : e.target.value;
    };

    // RAW Capture (Lossless PNG)
    document.getElementById('shutter').onclick = () => {
        if (navigator.vibrate) navigator.vibrate(40);
        const c = document.getElementById('c');
        const ctx = c.getContext('2d');
        c.width = v.videoWidth;
        c.height = v.videoHeight;
        ctx.filter = v.style.filter;
        ctx.drawImage(v, 0, 0);
        
        c.toBlob((blob) => {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `PRO_RAW_${Date.now()}.png`;
            link.click();
        }, 'image/png'); // High-quality lossless
    };
</script>
</body>
</html>
