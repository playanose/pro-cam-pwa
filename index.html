<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GCam PWA</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --google-blue: #4285F4; --surface: #121212; }
        body { margin: 0; background: #000; color: white; font-family: 'Roboto', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Viewfinder Area */
        #viewport { position: relative; flex-grow: 1; overflow: hidden; border-radius: 0 0 24px 24px; }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* HUD & Histogram */
        .hud-top { position: absolute; top: 40px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; }
        #hist { width: 80px; height: 40px; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); }
        .badge { background: rgba(0,0,0,0.5); padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; border: 1px solid var(--google-blue); color: var(--google-blue); }

        /* Mode Carousel */
        .mode-carousel { display: flex; justify-content: center; gap: 20px; padding: 10px 0; font-size: 12px; font-weight: bold; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .mode-active { color: white; border-bottom: 2px solid white; }

        /* Bottom Controls */
        .bottom-bar { background: var(--surface); padding-bottom: env(safe-area-inset-bottom); display: flex; flex-direction: column; align-items: center; padding-top: 10px; }
        .shutter-row { width: 100%; display: flex; justify-content: space-around; align-items: center; padding: 20px 0; }
        
        #preview-thumb { width: 50px; height: 50px; border-radius: 50%; background: #333; border: 2px solid white; background-size: cover; background-position: center; }
        
        #shutter { width: 75px; height: 75px; border-radius: 50%; border: 4px solid white; background: transparent; padding: 4px; position: relative; }
        #shutter-btn { width: 100%; height: 100%; border-radius: 50%; background: white; transition: transform 0.1s; }
        #shutter:active #shutter-btn { transform: scale(0.85); background: #ccc; }

        #switch-btn { width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.1); border: none; color: white; font-size: 20px; }

        /* Permission Overlay */
        #overlay { position: fixed; inset: 0; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        #btn-go { background: var(--google-blue); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>

<div id="overlay">
    <h2 style="margin-bottom:0">GCam Web</h2>
    <p style="color:#888">Professional Grade PWA</p>
    <button id="btn-go">OPEN CAMERA</button>
</div>

<div id="viewport">
    <video id="v" autoplay playsinline></video>
    <div class="hud-top">
        <canvas id="hist"></canvas>
        <div class="badge">RAW+ LUT</div>
    </div>
</div>

<div class="mode-carousel">
    <span>Night Sight</span>
    <span class="mode-active">Camera</span>
    <span>Portrait</span>
</div>

<div class="bottom-bar">
    <div class="shutter-row">
        <div id="preview-thumb"></div>
        <button id="shutter"><div id="shutter-btn"></div></button>
        <button id="switch-btn">ðŸ”„</button>
    </div>
</div>

<canvas id="hidden-canvas" style="display:none"></canvas>

<script>
    const v = document.querySelector('#v');
    const h = document.querySelector('#hist');
    const hCtx = h.getContext('2d');
    const thumb = document.querySelector('#preview-thumb');
    let track = null;

    // Register PWA
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');

    document.querySelector('#btn-go').onclick = async () => {
        try {
            const s = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: { ideal: 4096 } } 
            });
            v.srcObject = s;
            track = s.getVideoTracks()[0];
            document.querySelector('#overlay').style.display = 'none';
            processHUD();
        } catch (e) { alert("Enable Camera & HTTPS"); }
    };

    // Live GCam HUD (Histogram)
    function processHUD() {
        if (v.paused) return;
        hCtx.drawImage(v, 0, 0, 80, 40);
        const d = hCtx.getImageData(0, 0, 80, 40).data;
        let b = new Array(256).fill(0);
        for (let i = 0; i < d.length; i += 4) {
            b[Math.floor((d[i] + d[i+1] + d[i+2]) / 3)]++;
        }
        hCtx.clearRect(0, 0, 80, 40);
        hCtx.fillStyle = "#ffffff88";
        let max = Math.max(...b);
        for (let i = 0; i < 256; i++) {
            let val = (b[i] / max) * 40;
            hCtx.fillRect(i * (80/256), 40 - val, 1, val);
        }
        requestAnimationFrame(processHUD);
    }

    // Capture & Burst Mode
    document.querySelector('#shutter').onclick = async () => {
        if (navigator.vibrate) navigator.vibrate(40);
        const canvas = document.querySelector('#hidden-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = v.videoWidth;
        canvas.height = v.videoHeight;
        
        // Take Snapshot
        ctx.drawImage(v, 0, 0);
        const img = canvas.toDataURL('image/png'); // RAW (Lossless)
        
        // Update Gallery Thumbnail
        thumb.style.backgroundImage = `url(${img})`;

        // Save to File
        const link = document.createElement('a');
        link.href = img;
        link.download = `GCAM_${Date.now()}.png`;
        link.click();
    };
</script>
</body>
</html>
